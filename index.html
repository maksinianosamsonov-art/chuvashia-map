<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мир Снов Оксаны</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #0f172a;
            overflow: hidden;
            touch-action: none; /* Предотвращает зум и скролл на мобильных */
        }

        /* Анимация фона */
        .stars {
            background: black url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png) repeat;
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
            display: block;
            z-index: 0;
        }

        /* UI Элементы */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .hidden { display: none !important; }
        
        /* Анимация персонажа в UI */
        .avatar-pulse {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }

        /* Текст диалога */
        .typing-text::after {
            content: '|';
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="text-white h-screen w-screen flex flex-col items-center justify-center relative">

    <!-- Задний фон -->
    <div class="stars opacity-50"></div>

    <!-- UI: Главное меню -->
    <div id="start-screen" class="glass-panel p-8 flex flex-col items-center justify-center max-w-sm w-[90%] z-20 absolute transition-all duration-500">
        <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-pink-500 to-violet-500 mb-4 p-1 avatar-pulse relative overflow-hidden">
             <!-- Здесь схематичное изображение Оксаны, можно заменить на <img> -->
             <svg viewBox="0 0 100 100" class="w-full h-full bg-slate-900 rounded-full">
                <circle cx="50" cy="40" r="25" fill="#fce7f3" /> <!-- Лицо -->
                <path d="M20,40 Q50,5 80,40" fill="none" stroke="#3b0764" stroke-width="8" /> <!-- Волосы -->
                <path d="M20,40 L20,90 Q50,110 80,90 L80,40" fill="#3b0764" /> <!-- Волосы сзади -->
                <circle cx="40" cy="40" r="3" fill="#000" /> <!-- Глаз -->
                <circle cx="60" cy="40" r="3" fill="#000" /> <!-- Глаз -->
                <path d="M45,55 Q50,60 55,55" fill="none" stroke="#000" stroke-width="2" /> <!-- Улыбка -->
             </svg>
        </div>
        <h1 class="text-3xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-violet-400">Оксана</h1>
        <h2 class="text-xl mb-4 font-bold text-gray-200">В Мире Снов</h2>
        <p class="text-center text-sm text-gray-300 mb-6 leading-relaxed">
            Помоги Оксане собрать звезды и убежать от кошмаров, чтобы проснуться.
        </p>
        <button onclick="startGame()" class="w-full bg-gradient-to-r from-pink-600 to-violet-600 hover:from-pink-500 hover:to-violet-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95">
            Начать путешествие
        </button>
    </div>

    <!-- UI: Диалог -->
    <div id="dialog-box" class="hidden glass-panel absolute bottom-8 w-[90%] p-4 z-20 flex items-start gap-4 animate-bounce-in">
        <div class="w-12 h-12 rounded-full bg-pink-500 flex-shrink-0 overflow-hidden border-2 border-white">
             <svg viewBox="0 0 100 100" class="w-full h-full bg-slate-800">
                <circle cx="50" cy="40" r="25" fill="#fce7f3" />
                <path d="M20,40 Q50,5 80,40" fill="none" stroke="#3b0764" stroke-width="8" />
             </svg>
        </div>
        <div class="flex-1">
            <h3 class="text-pink-400 font-bold text-xs uppercase mb-1">Оксана</h3>
            <p id="dialog-text" class="text-sm leading-snug typing-text"></p>
            <p class="text-xs text-gray-400 mt-2 text-right">Нажми, чтобы продолжить...</p>
        </div>
    </div>

    <!-- UI: Счет и Жизни -->
    <div id="hud" class="hidden absolute top-4 left-0 w-full px-4 flex justify-between z-10 pointer-events-none">
        <div class="glass-panel px-3 py-1 flex items-center gap-2">
            <span class="text-yellow-400 text-xl">★</span>
            <span id="score" class="font-bold text-lg">0</span>
        </div>
        <div class="glass-panel px-3 py-1">
            <span class="text-xs text-gray-300">РЕКОРД: <span id="highscore">0</span></span>
        </div>
    </div>

    <!-- UI: Game Over -->
    <div id="game-over" class="hidden glass-panel p-8 flex flex-col items-center justify-center max-w-sm w-[90%] z-20 absolute">
        <h2 class="text-3xl font-black mb-2 text-red-400">Ой!</h2>
        <p class="text-center text-gray-300 mb-6">Кошмар догнал тебя.<br>Собрано звезд: <span id="final-score" class="text-yellow-400 font-bold">0</span></p>
        <button onclick="resetGame()" class="w-full bg-white text-slate-900 font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95">
            Попробовать снова
        </button>
    </div>

    <canvas id="gameCanvas" class="game-canvas"></canvas>

    <script>
        // --- Telegram Integration ---
        const tg = window.Telegram.WebApp;
        tg.expand(); // Разворачиваем на весь экран
        tg.ready();
        
        // --- Game Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        const resize = () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        };
        window.addEventListener('resize', resize);
        resize();

        // --- Game State ---
        let gameActive = false;
        let score = 0;
        let highScore = localStorage.getItem('oksana_game_hs') || 0;
        document.getElementById('highscore').innerText = highScore;
        let frame = 0;
        let gameSpeed = 5;
        let difficultyMultiplier = 1;

        // --- Story Data ---
        const storyLines = [
            "Где я? Это похоже на сон...",
            "Нужно собирать эти звезды, чтобы осветить путь!",
            "Эти красные блоки выглядят опасно...",
            "Я чувствую, что становлюсь быстрее!"
        ];
        let storyIndex = 0;

        // --- Assets (Drawing Functions) ---
        // Рисуем Оксану (упрощенно для Canvas)
        const drawPlayer = (x, y, w, h, isJumping) => {
            ctx.save();
            ctx.translate(x + w/2, y + h/2);
            // Прыжок - небольшой наклон
            if(isJumping) ctx.rotate(-0.2); 
            else ctx.rotate(Math.sin(frame * 0.1) * 0.05); // Бег - покачивание

            // Тело
            ctx.fillStyle = '#ec4899'; // Розовый
            ctx.fillRect(-w/2, -h/2 + 10, w, h-10);
            
            // Голова
            ctx.fillStyle = '#fce7f3'; // Светлая кожа
            ctx.beginPath();
            ctx.arc(0, -h/2 + 5, w/1.8, 0, Math.PI * 2);
            ctx.fill();

            // Волосы
            ctx.fillStyle = '#3b0764'; // Темные волосы
            ctx.beginPath();
            ctx.arc(0, -h/2 + 5, w/1.6, Math.PI, Math.PI * 2);
            ctx.fill();
            
            // Глаза
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-5, -h/2 + 5, 2, 0, Math.PI * 2);
            ctx.arc(5, -h/2 + 5, 2, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
            
            // Эффект следа (Trail)
            if (frame % 5 === 0) {
                particles.push(new Particle(x, y + h, 'rgba(236, 72, 153, 0.5)'));
            }
        };

        // --- Classes ---
        class Player {
            constructor() {
                this.w = 40;
                this.h = 60;
                this.x = 50;
                this.y = height - 150; // Ground level
                this.dy = 0;
                this.jumpPower = -15;
                this.gravity = 0.8;
                this.isJumping = false;
                this.groundY = height - 100;
            }

            update() {
                // Gravity
                this.dy += this.gravity;
                this.y += this.dy;

                // Ground collision
                if (this.y + this.h > this.groundY) {
                    this.y = this.groundY - this.h;
                    this.dy = 0;
                    this.isJumping = false;
                }
            }

            jump() {
                if (!this.isJumping) {
                    this.dy = this.jumpPower;
                    this.isJumping = true;
                    // Haptic feedback for Telegram
                    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                }
            }

            draw() {
                drawPlayer(this.x, this.y, this.w, this.h, this.isJumping);
            }
        }

        class Obstacle {
            constructor() {
                this.w = 30 + Math.random() * 20;
                this.h = 30 + Math.random() * 30;
                this.x = width;
                this.y = (height - 100) - this.h;
                this.color = '#ef4444'; // Red danger
                this.markedForDeletion = false;
            }

            update() {
                this.x -= gameSpeed;
                if (this.x + this.w < 0) this.markedForDeletion = true;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.shadowBlur = 0;
            }
        }

        class Star {
            constructor() {
                this.size = 15;
                this.x = width;
                this.y = (height - 100) - 40 - Math.random() * 100; // Random height
                this.markedForDeletion = false;
                this.angle = 0;
            }

            update() {
                this.x -= gameSpeed;
                this.angle += 0.1;
                if (this.x + this.size < 0) this.markedForDeletion = true;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath();
                for(let i = 0; i < 5; i++){
                    ctx.lineTo(Math.cos((18 + i * 72) * 0.0174533) * this.size, 
                               Math.sin((18 + i * 72) * 0.0174533) * this.size);
                    ctx.lineTo(Math.cos((54 + i * 72) * 0.0174533) * (this.size/2), 
                               Math.sin((54 + i * 72) * 0.0174533) * (this.size/2));
                }
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + 2;
                this.speedY = Math.random() * 1 - 0.5;
                this.speedX = -gameSpeed;
                this.color = color;
                this.life = 1;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life -= 0.05;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        // --- Logic Variables ---
        let player = new Player();
        let obstacles = [];
        let stars = [];
        let particles = [];
        let obstacleTimer = 0;
        let starTimer = 0;

        // --- Input Handling ---
        const handleInput = () => {
            if (gameActive) {
                // Если диалог открыт, закрываем его
                const dialog = document.getElementById('dialog-box');
                if (!dialog.classList.contains('hidden')) {
                    closeDialog();
                    return;
                }
                player.jump();
            }
        };

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') handleInput();
        });
        window.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent double firing
            handleInput();
        }, {passive: false});
        window.addEventListener('mousedown', handleInput);

        // --- Dialog System ---
        function showDialog(text) {
            gameActive = false; // Pause game logic, but loop continues for rendering
            const dialog = document.getElementById('dialog-box');
            const textEl = document.getElementById('dialog-text');
            dialog.classList.remove('hidden');
            
            // Typewriter effect
            textEl.innerHTML = '';
            let i = 0;
            const type = () => {
                if (i < text.length) {
                    textEl.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, 30);
                }
            };
            type();
        }

        function closeDialog() {
            document.getElementById('dialog-box').classList.add('hidden');
            gameActive = true;
            // Увеличиваем сложность после диалога
            gameSpeed += 0.5;
        }

        // --- Core Functions ---

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('game-over').classList.add('hidden');
            
            resetVars();
            gameActive = true;
            
            // Show intro dialog immediately
            setTimeout(() => showDialog(storyLines[0]), 500);
            
            animate();
        }

        function resetVars() {
            player = new Player();
            obstacles = [];
            stars = [];
            particles = [];
            score = 0;
            gameSpeed = 5;
            document.getElementById('score').innerText = '0';
            frame = 0;
        }

        function resetGame() {
            startGame();
        }

        function gameOver() {
            gameActive = false;
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('oksana_game_hs', highScore);
                document.getElementById('highscore').innerText = highScore;
            }
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
        }

        function checkCollisions() {
            // Obstacles
            obstacles.forEach(obs => {
                if (
                    player.x < obs.x + obs.w &&
                    player.x + player.w > obs.x &&
                    player.y < obs.y + obs.h &&
                    player.y + player.h > obs.y
                ) {
                    gameOver();
                }
            });

            // Stars
            stars.forEach(star => {
                if (!star.markedForDeletion &&
                    player.x < star.x + star.size &&
                    player.x + player.w > star.x &&
                    player.y < star.y + star.size &&
                    player.y + player.h > star.y
                ) {
                    star.markedForDeletion = true;
                    score += 10;
                    document.getElementById('score').innerText = score;
                    if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                    
                    // Trigger particles
                    for(let k=0; k<5; k++) particles.push(new Particle(star.x, star.y, '#fbbf24'));

                    // Story Triggers based on score
                    if (score === 50) showDialog(storyLines[1]);
                    if (score === 150) showDialog(storyLines[2]);
                    if (score === 300) showDialog(storyLines[3]);
                }
            });
        }

        // --- Main Loop ---
        function animate() {
            if (!document.getElementById('game-over').classList.contains('hidden')) return; // Stop if game over

            ctx.clearRect(0, 0, width, height);

            // Draw Floor
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, height - 100, width, 100);
            ctx.fillStyle = '#334155'; // Ground detail
            ctx.fillRect(0, height - 95, width, 2);

            if (gameActive) {
                frame++;
                
                // Spawn Obstacles
                if (obstacleTimer > 150 - (gameSpeed * 2) + Math.random() * 50) {
                    obstacles.push(new Obstacle());
                    obstacleTimer = 0;
                } else {
                    obstacleTimer++;
                }

                // Spawn Stars
                if (starTimer > 100 + Math.random() * 100) {
                    stars.push(new Star());
                    starTimer = 0;
                } else {
                    starTimer++;
                }

                player.update();
                
                // Update Objects
                [...obstacles, ...stars, ...particles].forEach(obj => obj.update());
                
                // Cleanup
                obstacles = obstacles.filter(o => !o.markedForDeletion);
                stars = stars.filter(s => !s.markedForDeletion);
                particles = particles.filter(p => p.life > 0);
                
                checkCollisions();
            }

            // Draw Everything
            stars.forEach(s => s.draw());
            obstacles.forEach(o => o.draw());
            player.draw();
            particles.forEach(p => p.draw());

            requestAnimationFrame(animate);
        }

        // First resize to set ground correct
        resize();
        
    </script>
</body>
</html>
