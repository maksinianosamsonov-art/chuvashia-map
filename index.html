<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ß—É–≤–∞—à–∏—è ‚Äî –ú–µ—Ç–∫–∏</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background-color: #1a1a1a;
    }
    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    .leaflet-bar a {
      background-color: #333;
      color: #eee;
      border-bottom: 1px solid #444;
    }
    .leaflet-bar a:hover {
      background-color: #444;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    #sticker-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #sticker-modal.active {
      display: flex;
      opacity: 1;
    }

    .sticker-btn {
      transition: transform 0.2s;
      background: #444;
      color: white;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
    }
    .sticker-btn:hover {
      transform: scale(1.1);
      background: #555;
    }
    .sticker-btn:active {
      transform: scale(0.95);
    }

    /* –°—Ç–∞—Ç—É—Å */
    .status-hint {
      position: absolute;
      bottom: 6px;
      left: 6px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      color: #ffcc00;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: monospace;
      border: 1px solid rgba(255, 204, 0, 0.3);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .status-hint .pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffcc00;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .control-panel {
      position: absolute;
      top: 4px;
      right: 4px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .control-btn {
      background: #444;
      color: white;
      border: 1px solid #555;
      border-radius: 50%;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .control-btn:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="sticker-modal" onclick="closeModal(event)">
    <div style="background: #2d2d2d; border: 1px solid #444; border-radius: 12px; padding: 16px; text-align: center; max-width: 280px; width: 90%;">
      <h3 style="color: white; margin-bottom: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–∫—É</h3>
      <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 16px;">
        <button onclick="addSticker('car')" class="sticker-btn">
          <div style="font-size: 10px;">–î–ü–°</div>
        </button>
        <button onclick="addSticker('sign')" class="sticker-btn">
          <div style="font-size: 10px;">–î–¢–ü</div>
        </button>
      </div>
      <p style="color: #777; font-size: 10px;">–ú–µ—Ç–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç</p>
    </div>
  </div>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
  <div class="status-hint">
    <span class="pulse"></span>
    –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–æ—á–∫—É –¥–ª—è –º–µ—Ç–∫–∏
  </div>

  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="control-panel">
    <button id="themeToggle" class="control-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
      <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" style="height: 16px; width: 16px; display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" style="height: 16px; width: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
    </button>
    <button id="locateBtn" class="control-btn" onclick="locateUser()" title="–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
      <svg xmlns="http://www.w3.org/2000/svg" style="height: 16px; width: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    </button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // === 1. –ì—Ä–∞–Ω–∏—Ü—ã –ß—É–≤–∞—à–∏–∏ ===
    const chuvashiaReal = [
      [56.120, 46.500], [56.130, 46.550], [56.160, 46.600], [56.195, 46.720], [56.180, 46.850],
      [56.150, 47.000], [56.145, 47.150], [56.160, 47.250], [56.130, 47.450], [56.140, 47.550],
      [56.100, 47.700], [56.050, 47.850], [56.000, 48.000], [55.950, 48.100], [55.850, 48.250],
      [55.750, 48.200], [55.650, 48.350], [55.550, 48.450], [55.450, 48.400], [55.350, 48.300],
      [55.250, 48.250], [55.150, 48.150], [55.100, 48.100], [55.050, 48.050], [55.000, 48.000],
      [54.950, 47.950], [54.900, 47.850], [54.850, 47.750], [54.800, 47.650], [54.750, 47.600],
      [54.700, 47.550], [54.650, 47.450], [54.600, 47.300], [54.580, 47.200], [54.600, 47.100],
      [54.650, 46.950], [54.700, 46.850], [54.750, 46.750], [54.800, 46.650], [54.820, 46.550],
      [54.840, 46.450], [54.850, 46.350], [54.880, 46.250], [54.950, 46.200], [55.000, 46.180],
      [55.050, 46.150], [55.150, 46.120], [55.250, 46.100], [55.350, 46.080], [55.450, 46.100],
      [55.550, 46.120], [55.650, 46.150], [55.750, 46.180], [55.850, 46.200], [55.950, 46.250],
      [56.000, 46.300], [56.050, 46.350], [56.080, 46.400], [56.120, 46.500]
    ];

    // === 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ===
    const map = L.map('map', {
      center: [55.45, 47.25],
      zoom: 9,
      minZoom: 8,
      maxZoom: 18,
      zoomControl: false,
      attributionControl: false,
      maxBounds: L.latLngBounds([54.5, 45.8], [56.4, 48.6]),
      maxBoundsViscosity: 0.8
    });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 });
    const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
    darkLayer.addTo(map);

    let maskLayer, borderLayer, isDark = true;

    function drawLayers() {
      if (maskLayer) map.removeLayer(maskLayer);
      if (borderLayer) map.removeLayer(borderLayer);

      maskLayer = L.polygon([
        [[90, -180], [90, 180], [-90, 180], [-90, -180]],
        chuvashiaReal
      ], {
        color: 'transparent',
        fillColor: isDark ? '#080808' : '#ffffff',
        fillOpacity: isDark ? 0.95 : 0.75,
        interactive: false
      }).addTo(map);

      borderLayer = L.polyline(chuvashiaReal, {
        color: isDark ? '#444' : '#000',
        weight: 2,
        interactive: false
      }).addTo(map);
    }
    drawLayers();

    // === 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram ===
    function getTelegramDisplayName() {
      const tg = window.Telegram?.WebApp;
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        let name = user.first_name || "–î—Ä—É–≥";
        if (user.last_name) name += " " + user.last_name;
        if (user.username) name += " (@ " + user.username + ")";
        return name;
      }
      return "–ê–Ω–æ–Ω–∏–º";
    }

    // === 4. –õ–æ–≥–∏–∫–∞ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è ===
    let pressTimer;
    let selectedLocation = null;
    let startX, startY;
    const modal = document.getElementById('sticker-modal');

    // Touch
    map.on('touchstart', function(e) {
      if (e.originalEvent.touches.length > 1) return;
      startX = e.originalEvent.touches[0].clientX;
      startY = e.originalEvent.touches[0].clientY;
      pressTimer = setTimeout(() => {
        selectedLocation = e.latlng;
        modal.classList.add('active');
      }, 600);
    });

    map.on('touchmove', function(e) {
      const touch = e.originalEvent.touches[0];
      if (Math.abs(touch.clientX - startX) > 10 || Math.abs(touch.clientY - startY) > 10) {
        clearTimeout(pressTimer);
      }
    });

    map.on('touchend dragstart zoomstart', () => clearTimeout(pressTimer));

    // Mouse
    map.on('mousedown', function(e) {
      if (e.originalEvent.button !== 0) return;
      pressTimer = setTimeout(() => {
        selectedLocation = e.latlng;
        modal.classList.add('active');
      }, 600);
    });

    map.on('mouseup mousemove dragstart zoomstart', () => clearTimeout(pressTimer));
    map.on('contextmenu', e => {
      selectedLocation = e.latlng;
      modal.classList.add('active');
    });

    function closeModal(e) {
      if (e.target.id === 'sticker-modal') modal.classList.remove('active');
    }

    // === 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ —Å –∏–º–µ–Ω–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ===
    function addSticker(type) {
      modal.classList.remove('active');
      if (!selectedLocation) return;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      const now = Date.now();
      const lastUsed = localStorage.getItem('lastStickerTime');
      if (lastUsed && now - parseInt(lastUsed) < 5 * 60 * 1000) {
        alert("–í—ã –º–æ–∂–µ—Ç–µ —Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç.");
        return;
      }
      localStorage.setItem('lastStickerTime', now.toString());

      // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const displayName = getTelegramDisplayName();

      // –ò–∫–æ–Ω–∫–∞
      const size = type === 'car' ? [40, 24] : [30, 30];
      const emoji = type === 'car' ? 'üöì' : '‚ö†Ô∏è';
      const icon = L.divIcon({
        html: `<div style="font-size: ${size[0] / 2}px; text-align: center;">${emoji}</div>`,
        iconSize: size,
        iconAnchor: [size[0] / 2, size[1] / 2]
      });

      const marker = L.marker(selectedLocation, { icon: icon }).addTo(map);

      // –ò–º—è –Ω–∞–¥ –º–µ—Ç–∫–æ–π
      const nameLabel = L.divIcon({
        html: `<div style="background: black; color: white; padding: 2px 4px; border-radius: 3px; font-size: 10px; white-space: nowrap;">${displayName}</div>`,
        iconSize: [100, 20],
        iconAnchor: [50, 0],
        className: ''
      });
      L.marker(selectedLocation, { icon: nameLabel, interactive: false }).addTo(map);

      // –ü–æ–ø–∞–ø
      const popupContent = `<div style="text-align: center; padding: 4px; font-size: 12px;">
        <div><b>${type === 'car' ? '–ü–∞—Ç—Ä—É–ª—å –î–ü–°' : '–î–¢–ü'}</b></div>
        <div style="color: #aaa; font-size: 10px;">–æ—Ç ${displayName}</div>
        <button onclick="map.closePopup(); map.removeLayer(this.parentNode.parentNode.parentNode.parentNode)" 
                style="margin-top: 6px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; padding: 2px 6px; font-size: 10px; cursor: pointer;">
          –£–¥–∞–ª–∏—Ç—å
        </button>
      </div>`;
      marker.bindPopup(popupContent);

      // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
      setTimeout(() => {
        map.removeLayer(marker);
      }, 15 * 60 * 1000);
    }

    // === 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ===
    function toggleTheme() {
      isDark = !isDark;
      if (isDark) {
        map.removeLayer(lightLayer); map.addLayer(darkLayer);
        document.getElementById('sunIcon').style.display = 'none';
        document.getElementById('moonIcon').style.display = 'block';
        document.getElementById('themeToggle').style.background = '#444';
        document.getElementById('themeToggle').style.borderColor = '#555';
      } else {
        map.removeLayer(darkLayer); map.addLayer(lightLayer);
        document.getElementById('sunIcon').style.display = 'block';
        document.getElementById('moonIcon').style.display = 'none';
        document.getElementById('themeToggle').style.background = '#fff';
        document.getElementById('themeToggle').style.borderColor = '#ccc';
        document.getElementById('themeToggle').style.color = '#333';
      }
      drawLayers();
    }

    function locateUser() {
      map.locate({ setView: true, maxZoom: 14 });
    }

    map.on('locationfound', e => {
      L.marker(e.latlng).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
    });
  </script>
</body>
</html>


